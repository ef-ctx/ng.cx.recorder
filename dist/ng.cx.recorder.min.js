angular.module("ng.cx.recorder.templates",[]).run(["$templateCache",function(a){a.put("lib/ng.cx.recorder/ng.cx.recorder.tpl.html","<div class=\"recorder-controls {{ mediaHandler.state }}\" data-ng-class=\"{'minified': minified}\"><div class=\"button button-control\" data-ng-click=changeState()><i class=recorder-controls-icon data-ng-class=\"{\n            'recorder-controls-icon-disabled': (mediaHandler.state === MEDIA_STATE.disabled),\n            'recorder-controls-icon-record record': (mediaHandler.state === MEDIA_STATE.capturing),\n            'recorder-controls-icon-play': ( (mediaHandler.state === MEDIA_STATE.paused) || (mediaHandler.state === MEDIA_STATE.stopped) ),\n            'recorder-controls-icon-pause': (mediaHandler.state === MEDIA_STATE.playing),\n            'recorder-controls-icon-stop record': (mediaHandler.state === MEDIA_STATE.recording)\n"+'            }"></i></div><div class=time-tracker>{{time.formatted | date : \'mm:ss\'}}</div><div class=scrub-control><div class=progress-bar-backdrop><div class=progress-bar style="width: {{ time.percentage || 0 }}%"></div></div><input type=range min=0 max={{mediaHandler.duration}} step=0.1 data-ng-model=time.unformatted data-ng-mousedown=rangeHandlers.mouseDown() data-ng-mouseup=rangeHandlers.mouseUp() data-ng-change=rangeHandlers.change() data-ng-show="((mediaHandler.state !== MEDIA_STATE.disabled) && (mediaHandler.state !== MEDIA_STATE.capturing) && (mediaHandler.state !== MEDIA_STATE.recording))"></div><div class="button button-remove" data-ng-click=removeRecording() data-ng-show="((mediaHandler.state !== MEDIA_STATE.disabled) && (mediaHandler.state !== MEDIA_STATE.capturing) && (mediaHandler.state !== MEDIA_STATE.recording))"><i class="recorder-controls-icon recorder-controls-icon-delete"></i></div></div>')}]),function(a){"use strict";var b=a.module("ng.cx.recorder",["ng.cx.recorder.templates","ng.cx.ua"]),c={video:{capture:{video:{mandatory:{maxWidth:768,maxHeight:576}},audio:!1},record:{type:"video",video:{width:768,height:576},canvas:{width:768,height:576}}},audio:{capture:{video:!1,audio:!0},record:{type:"audio"}},multiple:{video:!0,audio:!0}},d={audio:"audio",video:"video",multiple:"multiple"},e={disabled:"disabled",capturing:"capturing",recording:"recording",playing:"playing",paused:"paused",stopped:"stopped"};b.service("userMedia",["$q","$window",function(a,b){function d(c){var d,e=a.defer();return f.getMedia?e.reject("getUserMedia() is not supported in your browser"):h.call(f,c,function(a){d={source:a,url:b.URL.createObjectURL(a)},e.resolve(d)},function(a){e.reject(a)}),e.promise}function e(a){if(g.hasOwnProperty(a))return d(g[a]);throw new Error("UserMedia.getMedia type: "+a+" is not a valid type of media, it has to be video or audio")}var f=b.navigator,g={audio:c.audio.capture,video:c.video.capture,multiple:c.multiple},h=f.getUserMedia||f.webkitGetUserMedia||f.mozGetUserMedia||f.msGetUserMedia;return{getMedia:e}}]),b.factory("SingleMedia",["$rootScope","$q","$window","userMedia",function(a,b,f,g){var h=function(h,i,j){function k(){var a="";a+="audio"===x?"--AUDIO--------":"--------VIDEO--",a+=F.toUpperCase(),a+="------------ volume: "+B.volume}function l(){var a=b.defer();return A?(B.src=A,B.volume=0,B.play(),F=e.capturing,a.resolve(A)):g.getMedia(x).then(function(b){z=b.source,A=b.url,B.src=A,B.play(),E=!0,F=e.capturing,D=new RecordRTC(b.source,y.record),k(),a.resolve(b)}),a.promise}function m(){var a;if(z){a=z.getTracks();for(var b=0;b<a.length;b++)a[b].stop();f.URL.revokeObjectURL(A),k()}}function n(){C&&(f.URL.revokeObjectURL(C),C=null),D.startRecording(),F=e.recording,k()}function o(){var a=b.defer();return D.stopRecording(function(b){C=b,B.src=b,a.resolve({type:x,blobUrl:b,blob:D.blob}),k()}),a.promise}function p(){B.play(),B.volume=.5,F=e.playing,k()}function q(){B.pause(),B.volume=0,F=e.paused,k()}function r(){var a=b.defer();return F===e.recording?o().then(function(b){a.resolve(b)}):a.resolve(),B.currentTime=0,B.pause(),B.volume=0,F=e.stopped,k(),a.promise}function s(){f.URL.revokeObjectURL(C),C=null,F=e.disabled,k(),l()}function t(){a.$evalAsync()}function u(){a.$evalAsync()}function v(){r(),a.$evalAsync()}function w(){if(x=j?"multiple":h.tagName.toLowerCase(),!d.hasOwnProperty(x))throw new Error("SingleMedia factory Error: type : "+x+" is not supported as media element");y=c[x],B=h,B.autoplay=!1,B.volume=0,B.addEventListener("timeupdate",t),B.addEventListener("ended",v),B.addEventListener("loadeddata",u),i?(B.src=i,F=e.paused):l()}var x,y,z,A,B,C,D,E=!1,F=e.disabled;this.play=p,this.stop=r,this.pause=q,this.record=n,this.capture=l,this.stopStream=m,this.removeRecording=s,Object.defineProperty(this,"hasRecording",{get:function(){return!!C}}),Object.defineProperty(this,"isCapturingEnabled",{get:function(){return E}}),Object.defineProperty(this,"state",{get:function(){return F}}),Object.defineProperty(this,"currentTime",{get:function(){return B.currentTime},set:function(a){B.currentTime=a}}),Object.defineProperty(this,"duration",{get:function(){return B.duration}}),Object.defineProperty(this,"muted",{get:function(){return B.muted||!1},set:function(a){B.muted=a}}),w()};return h}]),b.factory("MediaHandler",["$interval","$q","SingleMedia",function(a,b,c){var d=function(){function d(a,b,d){p.push(new c(a,b,d))}function f(){p.forEach(function(a){a.stopStream()})}function g(){p.forEach(function(a){a.record()}),n=0,m=a(function(){n===o?h():n++},1e3)}function h(){var c=b.defer(),d=[];return p.forEach(function(a){d.push(a.stop())}),b.all(d).then(function(a){c.resolve(a)}),m&&a.cancel(m),c.promise}function i(){p.forEach(function(a){a.play()})}function j(){p.forEach(function(a){a.pause()})}function k(){p.forEach(function(a){a.removeRecording()}),m&&a.cancel(m)}function l(){return p&&p[0]?p[0].state:void 0}var m,n,o,p=[];this.addMediaElement=d,this.stopStream=f,this.removeRecording=k,this.record=g,this.stop=h,this.pause=j,this.play=i,Object.defineProperty(this,"state",{get:l}),Object.defineProperty(this,"duration",{get:function(){var a=0;return l()===e.recording?a=n:p[0]&&(a=p[0].duration),a}}),Object.defineProperty(this,"currentTime",{get:function(){var a=0;return l()===e.recording?a=n:p[0]&&(a=p[0].currentTime),a},set:function(a){for(var b=0;b<p.length;b++)p[b].currentTime=a}}),Object.defineProperty(this,"isCapturingEnabled",{get:function(){for(var a=0;a<p.length;a++)if(!p[a].isCapturingEnabled)return!1;return!0}}),Object.defineProperty(this,"maxRecordingSeconds",{get:function(){return o},set:function(a){o=a}}),Object.defineProperty(this,"muted",{get:function(){return p[0]?p[0]:!1},set:function(a){for(var b=0;b<p.length;b++)p[b].muted=a}})};return d}]),b.directive("recorderControls",["$rootScope","cxUA","MediaHandler",function(b,c,d){return{restrict:"A",templateUrl:"lib/ng.cx.recorder/ng.cx.recorder.tpl.html",replace:"element",scope:{videoElement:"=",audioElement:"=",videoUrl:"=",audioUrl:"=",minified:"=",registerControlsApi:"=",maxRecordingTime:"=",muted:"=",includeAudio:"=",mediaRecordedHandler:"="},controller:["$scope",function(b){function c(){var a=0;return a=b.mediaHandler.state===e.recording?100*b.mediaHandler.duration/b.maxDuration:100*b.time.unformatted/b.mediaHandler.duration,Math.ceil(a)}var f="ng.cx.recorder";b.MEDIA_STATE=e,b.mediaHandler=new d,b.rangeHandlers={mouseDown:function(){b.time.trackingEnabled=!1,b.mediaHandler.pause()},mouseUp:function(){b.time.trackingEnabled=!0},change:function(){b.mediaHandler.currentTime=b.time.unformatted,b.mediaHandler.play()}},b.time={trackingEnabled:!0,unformatted:0,formatted:new Date(null),percentage:0},b.$watch("muted",function(a){b.mediaHandler.muted=a}),b.$watch("mediaHandler.currentTime",function(a){b.time.trackingEnabled&&(b.time.unformatted=a),b.time.formatted=new Date(0),b.time.formatted.setSeconds(a),b.time.percentage=c()}),b.changeState=function(){if(b.mediaHandler.stop(),b.mediaHandler.stopStream(),b.mediaHandler.state!==e.disabled)switch(b.mediaHandler.state){case e.capturing:b.mediaHandler.record();break;case e.recording:b.mediaHandler.stop().then(function(c){b.mediaRecordedHandler&&a.isFunction(b.mediaRecordedHandler)&&b.mediaRecordedHandler(c)});break;case e.paused:b.mediaHandler.play();break;case e.stopped:b.mediaHandler.play();break;case e.playing:b.mediaHandler.pause()}},b.removeRecording=function(){b.mediaHandler.removeRecording(),b.$emit(f+".recordRemoved")},b.$on("$destroy",function(){b.mediaHandler.stop(),b.mediaHandler.stopStream()})}],link:function(b,d){function e(){c.isFirefox?b.videoElement&&(b.includeAudio?b.mediaHandler.addMediaElement(b.videoElement,b.videoUrl,!0):b.mediaHandler.addMediaElement(b.videoElement,b.videoUrl)):(b.includeAudio&&b.mediaHandler.addMediaElement(a.element("<audio>")[0],b.audioUrl),b.videoElement&&b.mediaHandler.addMediaElement(b.videoElement,b.videoUrl))}b.registerControlsApi&&b.registerControlsApi({record:b.mediaHandler.record,play:b.mediaHandler.play,stop:b.mediaHandler.stop}),b.maxDuration=b.maxRecordingTime||120,b.mediaHandler.maxRecordingSeconds=b.maxDuration,b.$evalAsync(e)}}}])}(angular);